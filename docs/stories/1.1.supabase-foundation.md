# Story 1.1: Supabase Foundation and Infrastructure Setup

## Status
Draft

## Story
**As a** developer,  
**I want** Supabase infrastructure established with proper authentication and database schema,  
**so that** the conversational AI has a robust real-time backend foundation.

## Acceptance Criteria
1. Supabase project configured with authentication enabled
2. Database schema implemented matching existing data requirements (groups, expenses, users, activities)
3. Supabase client properly configured in Next.js application
4. Environment variables and configuration management established
5. Basic real-time subscription capabilities tested and working
6. API documentation created in `.bmad-core/data/external-apis/supabase-core-patterns.md`

## Tasks / Subtasks

- [ ] **Task 1: Supabase Project Setup** (AC: 1)
  - [ ] Create new Supabase project
  - [ ] Configure authentication providers
  - [ ] Set up Row Level Security (RLS) policies
  - [ ] Configure database settings for PostgreSQL compatibility

- [ ] **Task 2: Database Schema Migration** (AC: 2)
  - [ ] Create Supabase tables matching existing Prisma schema
  - [ ] Implement Group table with proper constraints
  - [ ] Implement Participant table with cascade relationships
  - [ ] Implement Expense table with all existing fields
  - [ ] Implement ExpensePaidFor junction table
  - [ ] Implement Category table with default categories
  - [ ] Implement Activity table for audit logging
  - [ ] Implement ExpenseDocument table for file references
  - [ ] Implement RecurringExpenseLink table
  - [ ] Create all required indexes and constraints
  - [ ] Set up enum types (SplitMode, RecurrenceRule, ActivityType)

- [ ] **Task 3: Supabase Client Integration** (AC: 3)
  - [ ] Install @supabase/supabase-js dependency
  - [ ] Create Supabase client configuration in lib/supabase.ts
  - [ ] Set up server-side and client-side Supabase clients
  - [ ] Configure authentication context and hooks
  - [ ] Create database access layer preserving existing API patterns

- [ ] **Task 4: Environment Configuration** (AC: 4)
  - [ ] Add Supabase environment variables to env.ts schema
  - [ ] Update container.env.example with Supabase variables
  - [ ] Add feature flags for Supabase vs Prisma operation
  - [ ] Ensure backward compatibility with existing Vercel Postgres setup

- [ ] **Task 5: Real-time Capabilities** (AC: 5)
  - [ ] Implement real-time subscriptions for expense updates
  - [ ] Add real-time listeners for group changes
  - [ ] Test real-time functionality with multiple clients
  - [ ] Ensure performance doesn't degrade existing functionality

- [ ] **Task 6: API Documentation** (AC: 6)
  - [ ] Create .bmad-core/data/external-apis/ directory
  - [ ] Document Supabase client patterns and usage
  - [ ] Document authentication flow and RLS policies
  - [ ] Document real-time subscription patterns

- [ ] **Task 7: Testing and Validation**
  - [ ] Create test suite for Supabase integration
  - [ ] Validate all existing tRPC endpoints work with Supabase
  - [ ] Test authentication flow end-to-end
  - [ ] Verify data integrity across all operations
  - [ ] Performance test against existing Prisma implementation

## Dev Notes

### Previous Story Insights
No previous stories exist - this is the foundation story for the conversational AI enhancement.

### Technology Stack Context
[Source: docs/BROWNFIELD_ARCHITECTURE.md#Technology Stack]
- **Current Database**: PostgreSQL with Prisma ORM (v5.6.0)
- **Current Hosting**: Vercel (with Vercel Postgres)
- **API Layer**: tRPC v11 (type-safe API)
- **Frontend**: Next.js 14.2.5 (App Router)

### Database Schema Requirements
[Source: prisma/schema.prisma]

**Core Models to Migrate:**
```prisma
// Group Model
model Group {
  id           String        @id
  name         String
  information  String?       @db.Text
  currency     String        @default("$")
  participants Participant[]
  expenses     Expense[]
  activities   Activity[]
  createdAt    DateTime      @default(now())
}

// Participant Model
model Participant {
  id              String           @id
  name            String
  group           Group            @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId         String
  expensesPaidBy  Expense[]
  expensesPaidFor ExpensePaidFor[]
}

// Expense Model (48 fields total)
model Expense {
  id              String            @id
  expenseDate     DateTime          @default(dbgenerated("CURRENT_DATE")) @db.Date
  title           String
  amount          Int               // Stored in cents
  splitMode       SplitMode         @default(EVENLY)
  // ... plus 40+ additional fields
}
```

**Critical Constraints:**
- Currency amounts stored as integers in cents (multiply by 100)
- Percentages stored out of 10000 (50% = 5000)
- Cascade deletes: Groups â†’ participants and expenses
- Required relationships: Every expense must have paidBy and paidFor participants

### Current Environment Schema
[Source: src/lib/env.ts]
**Existing Variables:**
- POSTGRES_URL_NON_POOLING: Required for Prisma
- POSTGRES_PRISMA_URL: Required for Prisma
- Feature flags: NEXT_PUBLIC_ENABLE_RECEIPT_EXTRACT, NEXT_PUBLIC_ENABLE_CATEGORY_EXTRACT
- OpenAI integration: OPENAI_API_KEY

**New Variables Needed:**
- NEXT_PUBLIC_SUPABASE_URL
- NEXT_PUBLIC_SUPABASE_ANON_KEY
- SUPABASE_SERVICE_ROLE_KEY
- NEXT_PUBLIC_ENABLE_SUPABASE (feature flag)

### Preservation Requirements
[Source: docs/BROWNFIELD_ARCHITECTURE.md#Development Guidelines]
1. **Maintain existing API contracts** - Do not modify existing tRPC procedures
2. **Preserve UI functionality** - All current features must remain accessible
3. **Respect data schemas** - Use existing Prisma models and validation
4. **Honor feature flags** - Follow existing configuration patterns
5. **Maintain i18n support** - Ensure new features support all languages

### Integration Strategy
[Source: docs/BROWNFIELD_ARCHITECTURE.md#API Integration Points]
- **Non-Destructive Enhancement**: Preserve all existing tRPC endpoints
- **Feature Flags**: Use environment-based configuration for gradual rollout
- **Fallback Mechanisms**: Maintain existing UI as primary interface
- **Context Management**: Leverage existing group context providers

### File Locations
[Source: Project Structure]
- Supabase client: `src/lib/supabase.ts`
- Environment schema: `src/lib/env.ts` (extend existing)
- API documentation: `.bmad-core/data/external-apis/supabase-core-patterns.md`
- Database migrations: Supabase dashboard SQL editor
- Feature flags: Follow existing pattern in `src/lib/featureFlags.ts`

### Testing Requirements
[Source: docs/BROWNFIELD_ARCHITECTURE.md#Testing Considerations]
- **Existing Jest configuration in place** - Preserve existing test patterns
- **Add Supabase-specific test scenarios** - Authentication, real-time, data integrity
- **Validate against existing expense splitting edge cases** - Ensure business logic accuracy
- **Performance testing** - Compare Supabase vs Prisma performance characteristics

### Technical Constraints
- **Data Integrity**: All monetary calculations use integer arithmetic (cents)
- **Cascade Deletes**: Maintain referential integrity with proper RLS policies
- **Performance**: tRPC with React Query patterns must remain efficient
- **Security**: No user authentication system currently (group-based access only)

## Testing

### Testing Standards
[Source: docs/BROWNFIELD_ARCHITECTURE.md#Testing Considerations]
- **Test Framework**: Jest (existing configuration)
- **Test Location**: `src/__tests__/` following existing patterns
- **Integration Tests**: Required for Supabase client functionality
- **Performance Tests**: Compare Supabase vs Prisma benchmark
- **Real-time Tests**: Multi-client subscription testing

### Required Test Coverage
- Supabase client initialization and configuration
- Database schema compatibility with existing Prisma models
- Authentication flow (if implemented)
- Real-time subscription functionality
- Data integrity across all CRUD operations
- Feature flag toggle between Supabase and Prisma

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-01-XX | 1.0 | Initial story creation | BMad Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*Results from QA Agent review of the completed story implementation* 